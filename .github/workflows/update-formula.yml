name: Update Heimdal Formula

on:
  repository_dispatch:
    types: [heimdal-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (e.g., 1.0.1)'
        required: true
      tag:
        description: 'Git tag (e.g., v1.0.1)'
        required: true

permissions:
  contents: write

jobs:
  update-formula:
    name: Update Formula
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set version variables
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="${{ github.event.inputs.tag }}"
          else
            VERSION="${{ github.event.client_payload.version }}"
            TAG="${{ github.event.client_payload.tag }}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "TAG=${TAG}" >> $GITHUB_ENV
          echo "Updating to version: ${VERSION} (${TAG})"
      
      - name: Download release binaries
        run: |
          # Download macOS binaries
          curl -L -o heimdal-darwin-amd64.tar.gz \
            "https://github.com/limistah/heimdal/releases/download/${TAG}/heimdal-darwin-amd64.tar.gz"
          curl -L -o heimdal-darwin-arm64.tar.gz \
            "https://github.com/limistah/heimdal/releases/download/${TAG}/heimdal-darwin-arm64.tar.gz"
      
      - name: Calculate SHA256 checksums
        run: |
          SHA256_AMD64=$(shasum -a 256 heimdal-darwin-amd64.tar.gz | awk '{print $1}')
          SHA256_ARM64=$(shasum -a 256 heimdal-darwin-arm64.tar.gz | awk '{print $1}')
          echo "SHA256_AMD64=${SHA256_AMD64}" >> $GITHUB_ENV
          echo "SHA256_ARM64=${SHA256_ARM64}" >> $GITHUB_ENV
          echo "AMD64 SHA256: ${SHA256_AMD64}"
          echo "ARM64 SHA256: ${SHA256_ARM64}"
      
      - name: Update formula
        run: |
          cat > Formula/heimdal.rb <<EOF
          class Heimdal < Formula
            desc "Universal dotfile and system configuration manager"
            homepage "https://github.com/limistah/heimdal"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/limistah/heimdal/releases/download/${TAG}/heimdal-darwin-arm64.tar.gz"
                sha256 "${SHA256_ARM64}"
              else
                url "https://github.com/limistah/heimdal/releases/download/${TAG}/heimdal-darwin-amd64.tar.gz"
                sha256 "${SHA256_AMD64}"
              end
            end

            def install
              bin.install "heimdal"
            end

            test do
              assert_match "heimdal ${VERSION}", shell_output("#{bin}/heimdal --version")
            end
          end
          EOF
      
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/heimdal.rb
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit - formula is already up to date"
            exit 0
          fi
          
          git commit -m "chore: update heimdal to ${VERSION}

          - Updated formula to version ${VERSION}
          - Updated download URLs to ${TAG}
          - Updated SHA256 checksums
          - Automated update via GitHub Actions"
          git push origin main
      
      - name: Create summary
        run: |
          echo "## Formula Updated Successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "- **AMD64 SHA256:** \`${SHA256_AMD64}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ARM64 SHA256:** \`${SHA256_ARM64}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Users can now install with:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "brew upgrade limistah/tap/heimdal" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
